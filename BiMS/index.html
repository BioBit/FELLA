<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
<title>BiMS Viewer</title>
<link href="css/ionic.css" rel="stylesheet">
<link href="css/app.css" rel="stylesheet">
<style>

.node {
  stroke-width: 1px;
}

.node .selected {
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
}

.brush .extent {
  fill-opacity: .1;
  stroke: #fff;
  shape-rendering: crispEdges;
}

</style>
<body>

    <div align='center' id="d3_graph"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="plot.js"></script>

<script>
viewNetwork("KEGGDB02_May_5.json","","")
var width = window.innerWidth,
    height = window.innerHeight,
    shiftKey, ctrlKey;
    //alert(width+" "+height)

    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)

    d3.selectAll('svg')
    .append('image')
    .attr('xlink:href','wscreen.png')
    .attr('class', 'pico')
    .attr('height', height)
    .attr('width', width)
    .attr('x', 0)//width/2-height/2)
    .attr('y', 0)//height/2-height/2)

function createNetwork() {
	filtered = window.prompt("Please, insert min/max mass values (m) or a single value to create the network.\n","150/1000")
	//el valor mínimo para que haya un nodo es 1.007825 y el máximo es 6176.018
	var minim = 1.007825
	var maxim = 6176.018	
	var coma = true
	while (coma) {
		ind = filtered.indexOf(",")
		if (ind!=-1) {filtered[ind] = "."}
		else {coma=false}
	}
	filtered = filtered.split("/")
	if (filtered.length==1) {
		filtn = Number(filtered[0])
		if (isNaN(filtn)) {
			minim = 0
			alert('"'+filtered[0]+'" is a word, not a number."')
		}
		else if (filtn<minim && filtn>maxim) { 
			minim = 0
			maxim = 7000			
			alert("Minimum and maximum allowed values are 1.007825 and 6176.018.") 
		}
		else if (filtn<minim) {
			minim = 0	
			alert("Minimum allowed value is 1.007825.")
		}
		else if (filtn>maxim) {
			maxim = 7000
			alert("Maximum allowed value is 6176.018.")
		}
		else {
			minim = filtn
			maxim = filtn
		}
	}
	else if (filtered.length==2) {
		filt1 = Number(filtered[0])
		filt2 = Number(filtered[1])
		if (isNaN(filt1) && isNaN(filt2)) {
			minim = 0		
			alert('"'+filtered[0]+'" and "'+filtered[1]+'" are words, not numbers."')
		}
		else if (isNaN(filt1)) {
			minim = 0
			alert('"'+filtered[0]+'" is a word, not a number."')
		}
		else if (isNaN(filt2)) {
			minim = 0
			alert('"'+filtered[1]+'" is a word, not a number."')
		}
		else if (filt1>filt2) {
			aux = filt1
			filt1 = filt2
			filt2 = aux
		}
		if (filt1<minim && filt2>maxim) { 
			minim = 0
			maxim = 7000			
			alert("Minimum and maximum allowed values are 1.007825 and 6176.018.") 
		}
		else if (filt1<minim) {
			minim = 0	
			alert("Minimum allowed value is 1.007825.")
		}
		else if (filt2>maxim) {
			maxim = 7000
			alert("Maximum allowed value is 6176.018.")
		}
		else {
			minim = filt1
			maxim = filt2
		}
	}
	else {
		minim = 0
		alert("Only one or two values required, not "+filtered.length+".")
	}
	if (minim>=1.007825 && maxim<=61676.018) {
		var nData = new Array();
		var nMass = new Array();
		d3.json("comp30.json", function(error, graph) {
			d3.csv("table-hmdb.csv",function(d) {
				return {
             	  			kegg_id: d.kegg_id,
					mono_mass: d.mono_mass
            			};
			}, function(error,rows) {
				graph.nodes.forEach(function(e) {
					rows.forEach(function(h) {
						if (e.name==h.kegg_id && h.mono_mass>=minim && h.mono_mass<=maxim && nData.indexOf(e.name)==-1) {
							//if (e.name=="C00350") {alert(nData.indexOf("C00350"))}
							//ee = h.mono_mass.toString()
							//alert(e.name)
							nData.push(e.name)
							nMass.push("Mass: "+h.mono_mass.toString())
						}
						else if (e.name==h.kegg_id && h.mono_mass>=minim && h.mono_mass<=maxim && nData.indexOf(e.name)!=-1 && nMass[nData.indexOf(e.name)].split(',').length%3!=0 && nMass[nData.indexOf(e.name)].indexOf(h.mono_mass.toString())==-1) {
							//alert(e.name)
							nMass[nData.indexOf(e.name)] = [nMass[nData.indexOf(e.name)],h.mono_mass].join(", ")
						}
						else if (e.name==h.kegg_id && h.mono_mass>=minim && h.mono_mass<=maxim && nData.indexOf(e.name)!=-1 && nMass[nData.indexOf(e.name)].indexOf(h.mono_mass.toString())==-1) {
							//alert(nData.indexOf(e.name)+"   "+nData.indexOf(e.name)%3)
							nMass[nData.indexOf(e.name)] = [nMass[nData.indexOf(e.name)],h.mono_mass].join(",\n")
						}
					})
				})
			})
		})
		setTimeout(function() { 
			//alert(nData.length)
			//alert(nMass[0]+"\n\n"+nMass[1]+"\n\n"+nMass[2]+"\n\n"+nMass[3]+"\n\n"+nMass[4])
			if (nData.length<=500) {
				d3.select("svg").remove();
		    		d3.selectAll("button").remove()
				viewNetwork("comp30.json",nData,nMass)}
			else {alert("Too many compounds to draw ("+nData.length+"). Please choose a smaller range of masses.")} 
		},1000)
	}
}

function viewGraph() {
	var fileSelected = document.getElementById("fileInput").files,
	    fileFormat = fileSelected[0].name.substring(fileSelected[0].name.length-5)
	if (fileFormat==".json") {
		d3.select("svg").remove();
    		d3.selectAll("button").remove()
		d3.json(fileSelected[0].name, function(error, graph) {
			//alert(graph.nodes[0].group)
			if (graph.nodes.length<=500) { viewNetwork(fileSelected[0].name,"","") }
			else if (graph.nodes.length>500 && graph.nodes[0].group!="C1") { alert("Network too big. Please, cluster nodes and try again.") }
              		else {viewClusters(fileSelected[0].name,"","")}
		})
	}
	else {alert("Please, select a '.json' file.");}
}

function viewKegg() {
	d3.select("svg").remove();
    	d3.selectAll("button").remove()
	viewClusters("comp29.json")
}
</script>
